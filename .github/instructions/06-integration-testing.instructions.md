# Integration Testing with Embedded Temporal Server

applyTo: "**/integration-tests/**,**/native-test/**,**/build.gradle"

---

## Overview

Integration tests run against an embedded Temporal test server, managed by Gradle. This enables full workflow execution testing without external dependencies.

## Current Implementation

### 1. Test Server Module (native-test)

#### TestServer.java
Location: [TestServer.java](native-test/src/main/java/io/ballerina/stdlib/workflow/testutils/TestServer.java)

```java
public class TestServer {
    private static TestWorkflowEnvironment testEnv;
    private static Server grpcServer;
    private static final int PORT = 7233;  // Test server port
    
    static void main(String[] args) throws Exception {
        // 1. Create Temporal test environment
        TestEnvironmentOptions options = TestEnvironmentOptions.newBuilder()
            .setUseExternalService(false)  // Embedded in-memory server
            .build();
        
        testEnv = TestWorkflowEnvironment.newInstance(options);
        
        // 2. Get service stubs from test environment
        WorkflowServiceStubs testStubs = testEnv.getWorkflowServiceStubs();
        
        // 3. Create gRPC server that delegates to test environment
        grpcServer = ServerBuilder.forPort(PORT)
            .addService(new WorkflowServiceImplBase() {
                // Delegate all methods to testEnv's service
                @Override
                public void startWorkflowExecution(...) {
                    testStubs.blockingStub().startWorkflowExecution(request);
                }
                // ... other methods delegate similarly
            })
            .build();
        
        grpcServer.start();
        System.out.println("Temporal test server started on port " + PORT);
        
        // 4. Keep running until interrupted
        grpcServer.awaitTermination();
    }
}
```

#### Shadow JAR Configuration (native-test/build.gradle)
```groovy
plugins {
    id 'java'
    id 'com.github.johnrengelman.shadow' version '8.1.1'
}

dependencies {
    implementation "io.temporal:temporal-testing:${temporalSdkVersion}"
    implementation "io.grpc:grpc-netty-shaded:${grpcVersion}"
    implementation "io.grpc:grpc-services:${grpcVersion}"
}

shadowJar {
    archiveBaseName.set('temporal-test-server')
    archiveClassifier.set('')
    manifest {
        attributes 'Main-Class': 'io.ballerina.stdlib.workflow.testutils.TestServer'
    }
    mergeServiceFiles()  // Merge META-INF/services files
}
```

### 2. Integration Tests Module (integration-tests)

#### Structure
```
integration-tests/
├── Ballerina.toml           # Test package configuration
├── Dependencies.toml        # Dependencies (workflow module)
├── *.bal                    # Workflow definitions
├── tests/
│   ├── Config.toml          # Generated by Gradle with server URL
│   └── *_test.bal           # Test files
└── build.gradle             # Gradle test lifecycle management
```

#### Config.toml (Generated by Gradle)
```toml
[ballerina.workflow.workflowConfig]
provider = "TEMPORAL"
url = "localhost:7233"       # Test server port (same as default Temporal server)
namespace = "default"

[ballerina.workflow.workflowConfig.params]
taskQueue = "BALLERINA_WORKFLOW_TASK_QUEUE"
maxConcurrentWorkflows = 100
maxConcurrentActivities = 100
```

#### Example Test File
```ballerina
import ballerina/test;
import ballerina/workflow;
import ballerina/io;

@workflow:Process
function simpleProcess(workflow:Context ctx, Input input) returns Output|error {
    return {id: input.id, result: "success"};
}

@test:Config {}
function testSimpleWorkflow() returns error? {
    // Start workflow
    string workflowId = check workflow:createInstance(simpleProcess, {id: "test-1", data: "test"});
    
    // Wait for completion and verify
    // ... test assertions
}
```

### 3. Gradle Test Infrastructure (integration-tests/build.gradle)

```groovy
def temporalProcess = null
def temporalPid = null
def pidFile = file("${buildDir}/temporal-server.pid")

// Task to start embedded Temporal test server
task startTestServer(dependsOn: ':workflow-native-test:shadowJar') {
    doLast {
        // Get the shadow JAR from native-test module
        def jarFile = project(':workflow-native-test').tasks.shadowJar.archiveFile.get().asFile
        
        // Start the server in a separate process
        ProcessBuilder pb = new ProcessBuilder('java', '-jar', jarFile.absolutePath)
        pb.redirectErrorStream(true)
        pb.redirectOutput(ProcessBuilder.Redirect.INHERIT)
        
        temporalProcess = pb.start()
        temporalPid = temporalProcess.pid()
        
        // Save PID for cleanup
        pidFile.parentFile.mkdirs()
        pidFile.text = temporalPid.toString()
        
        // Wait for server to be ready
        def ready = false
        def maxRetries = 30
        def retryCount = 0
        
        while (!ready && retryCount < maxRetries) {
            try {
                // Try to connect to the server
                def socket = new Socket('localhost', 7233)
                socket.close()
                ready = true
                println "Test server is ready on port 7233"
            } catch (Exception e) {
                retryCount++
                Thread.sleep(1000)
            }
        }
        
        if (!ready) {
            throw new GradleException("Temporal test server failed to start within 30 seconds")
        }
        
        // Create Config.toml for tests
        def configFile = file('tests/Config.toml')
        configFile.parentFile.mkdirs()
        configFile.text = """
[ballerina.workflow.workflowConfig]
provider = "TEMPORAL"
url = "localhost:7233"
namespace = "default"

[ballerina.workflow.workflowConfig.params]
taskQueue = "BALLERINA_WORKFLOW_TASK_QUEUE"
maxConcurrentWorkflows = 100
maxConcurrentActivities = 100
"""
    }
}

// Task to stop Temporal test server
task stopTestServer {
    doLast {
        if (pidFile.exists()) {
            def pid = pidFile.text.trim()
            println "Stopping Temporal test server (PID: ${pid})"
            
            try {
                if (System.getProperty('os.name').toLowerCase().contains('windows')) {
                    "taskkill /F /PID ${pid}".execute()
                } else {
                    "kill -9 ${pid}".execute()
                }
                Thread.sleep(1000)
            } catch (Exception e) {
                println "Warning: Could not stop server process: ${e.message}"
            }
            
            pidFile.delete()
        }
        
        // Clean up Config.toml
        def configFile = file('tests/Config.toml')
        if (configFile.exists()) {
            configFile.delete()
        }
    }
}

// Hook test task to start/stop server
tasks.named('test') {
    dependsOn startTestServer
    finalizedBy stopTestServer
}

// Ensure server is stopped even if build fails
gradle.buildFinished {
    stopTestServer.execute()
}

// Ballerina test task
task testBallerina(type: Exec, dependsOn: startTestServer) {
    workingDir projectDir
    commandLine 'bal', 'test'
    finalizedBy stopTestServer
}

// Make test depend on testBallerina
test.dependsOn testBallerina
```

### 4. Test Lifecycle Sequence

```
1. Gradle Test Invocation
   └─> ./gradlew :workflow-integration-tests:test

2. Dependencies Resolution
   ├─> :workflow-native-test:shadowJar
   │   └─> Builds temporal-test-server.jar with TestServer main class
   └─> :workflow-ballerina:build
       └─> Builds workflow module

3. startTestServer Task
   ├─> Executes: java -jar temporal-test-server.jar
   ├─> Waits for port 7233 to accept connections
   ├─> Saves PID to build/temporal-server.pid
   └─> Generates tests/Config.toml with server URL

4. testBallerina Task
   ├─> Executes: bal test in integration-tests/
   ├─> Ballerina reads Config.toml (url = localhost:7233)
   ├─> Module init() creates worker connected to test server
   ├─> Tests execute workflows against embedded server
   └─> Test results reported

5. stopTestServer Task (finalizedBy)
   ├─> Reads PID from build/temporal-server.pid
   ├─> Kills server process (kill -9 on Unix, taskkill on Windows)
   ├─> Deletes PID file
   └─> Deletes tests/Config.toml

6. Cleanup (buildFinished hook)
   └─> Ensures stopTestServer runs even on failure
```

## Test Categories

### Unit Tests (ballerina/tests/)
- No Temporal server needed
- Tests registration, introspection, type conversions
- All processes registered once in `@test:BeforeSuite`, tests verify specific registrations
- Example: Test `getRegisteredWorkflows()`
```ballerina
@test:BeforeSuite
function setup() returns error? {
    _ = check workflow:registerProcess(myProcess, "myProcess");
}

@test:Config {}
function testRegistration() returns error? {
    WorkflowRegistry registry = check workflow:getRegisteredWorkflows();
    test:assertTrue(registry.hasKey("myProcess"));
}
```

### Integration Tests (integration-tests/tests/)
- Uses embedded Temporal server
- Tests full workflow execution, activities, signals
- Example: Test workflow start, signal sending, completion
```ballerina
@test:Config {}
function testWorkflowExecution() returns error? {
    string wfId = check workflow:createInstance(orderProcess, {id: "order-1"});
    _ = check workflow:sendEvent(orderProcess, {id: "order-1", approved: true}, "approval");
    // Wait and verify result
}
```

### Compiler Plugin Tests (compiler-plugin-tests/)
- Tests compile-time validations
- No Temporal server needed
- Example: Test WORKFLOW_107, WORKFLOW_108 errors

## Port Configuration

- **Production**: `localhost:7233` (default Temporal server)
- **Integration Tests**: `localhost:7233` (embedded test server - same port as production for simplicity)
- **Configurable**: Via `Config.toml` in each module

## Success Criteria

✅ **Test Server Lifecycle:**
- Shadow JAR builds successfully with all dependencies
- Server starts on port 7233 within 30 seconds
- Server accepts gRPC connections
- Server stops cleanly after tests complete
- Server stops even if tests fail (buildFinished hook)
- PID file created and cleaned up properly

✅ **Configuration:**
- Config.toml generated with correct server URL
- Ballerina module reads Config.toml successfully
- Worker connects to test server (not production server)
- Config.toml cleaned up after tests

✅ **Test Execution:**
- Unit tests run without Temporal server
- Integration tests run against embedded server
- Workflows execute successfully in tests
- Activities execute successfully in tests
- Signals delivered successfully in tests
- Test failures reported correctly

✅ **Build Integration:**
- `./gradlew test` runs all test types
- `./gradlew :workflow-integration-tests:test` runs integration tests only
- `./gradlew :workflow-ballerina:test` runs unit tests only
- `./gradlew :workflow-compiler-plugin-tests:test` runs plugin tests only
- Build fails fast if server fails to start
- No orphaned server processes after build

✅ **Isolation:**
- Each test run uses fresh server instance
- No state leakage between test runs
- Tests can run in parallel (if properly isolated)
- Server shutdown doesn't leave connections open
